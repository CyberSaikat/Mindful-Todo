<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindful Todo</title>
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/animate.min.css" rel="stylesheet">
    <link href="static/css/jquery.datetimepicker.min.css" rel="stylesheet">
    <link href="static/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="static/css/custom.css" rel="stylesheet">
    <link href="static/css/all.min.css" rel="stylesheet">
    <link href="static/css/toastr.min.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: var(--primary-color)">
        <div class="container">
            <a class="navbar-brand" href="/">âœ¨ Mindful Todo</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">Analytics</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Task Input Form -->
                <div class="card task-card not-hover mb-4">
                    <div class="card-body">
                        <form id="addTaskForm" method="POST" action="/add" onsubmit="return false">
                            <div class="mb-3">
                                <input type="text" name="name" id="taskName" class="form-control form-control-lg"
                                    placeholder="What's on your mind today?" required>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <select class="form-select" name="priority" id="taskPriority">
                                        <option value="low">Low Priority</option>
                                        <option value="medium">Medium Priority</option>
                                        <option value="high">High Priority</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" name="category" id="taskCategory">
                                        <option value="personal">Personal</option>
                                        <option value="work">Work</option>
                                        <option value="health">Health</option>
                                        <option value="learning">Learning</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" name="due_date" id="dueDate" class="form-control datetimepicker" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">Add Task</button>
                        </form>
                        <!-- Success/Error message area -->
                        <div id="taskFeedback" class="mt-3"></div>
                    </div>
                </div>

                <!-- Tasks Table -->
                <div class="row">
                    <div class="col-12">
                        <table class="table mt-5 table-bordered" id="taskTable"></table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- Stats Cards -->
                <div class="stats-card">
                    <h5 class="mb-3">Task Distribution</h5>
                    <div id="task-distribution"></div>
                </div>
                <div class="stats-card">
                    <h5 class="mb-3">Weekly Progress</h5>
                    <div id="weekly-progress"></div>
                </div>

                <div class="stats-card">
                    <h5 class="mb-3">Productive Hours</h5>
                    <div id="productivity-hours"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="static/js/jquery-3.7.1.min.js"></script>
    <script src="static/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/jquery.dataTables.min.js"></script>
    <script src="static/js/apexcharts.min.js"></script>
    <script src="static/js/jquery.datetimepicker.full.min.js"></script>
    <script src="static/js/toastr.min.js"></script>
    <script src="static/js/home.js"></script>
    <script>
        $(document).ready(function () {
            // Initialize datetime picker
            $('.datetimepicker').datetimepicker({
                format: 'd-m-Y H:i',
                step: 30,
                mask: true
            });

            // Initialize DataTables with server-side processing
            $('#taskTable').DataTable({
                processing: true,
                serverSide: true,
                responsive: true,
                ajax: {
                    url: '/tasks', // The URL to fetch data
                    type: 'GET',
                    data: function (d) {
                        // Optional: you can add filters here if needed, e.g.:
                        // d.category = $('#filterCategory').val();
                    }
                },
                columns: [
                    { data: 'id', title: 'ID', visible: false },
                    { data: 'sl_no', title: 'S.No', orderable: false },
                    { data: 'name', title: 'Task', orderable: false },
                    {
                        data: 'category',
                        title: 'Category',
                        orderable: false,
                        render: function (data, type, row) {
                            if(row.priority === 'High') {
                                return `<span class="badge bg-danger">${data} (${row.priority})</span>`;
                            } else if(row.priority === 'Medium') {
                                return `<span class="badge bg-warning text-black">${data} (${row.priority})</span>`;
                            }
                            return `<span class="badge bg-primary">${data} (${row.priority})</span>`;
                        }
                    },
                    { data: 'due_date', title: 'Due Date', orderable: false },
                    {
                        data: 'id',
                        title: 'Actions',
                        orderable: false,
                        render: function (data, type, row) {
                            if(row.is_completed) {
                                return `<button class="btn btn-sm btn-danger delete-task" data-task-id="${data}" title="Delete task"><i class="fa fa-trash"></i></button>`;
                            }
                            return `
                                <div class="d-flex gap-2" role="group">
                                    <button class="btn btn-sm btn-primary complete-task" data-task-id="${data}" title="Mark as complete"><i class="fa fa-check"></i></button>
                                    <button class="btn btn-sm btn-danger delete-task" data-task-id="${data}" title="Delete task"><i class="fa fa-trash"></i></button>
                                </div>
                            `;
                        }
                    },
                ],
                rowCallback: function (row, data) {
                    if (data.is_completed) {
                        $(row).addClass('table-success');
                    } else if (new Date(data.due_date) < new Date()) {
                        $(row).addClass('table-danger');
                    } else if (data.priority === 'high') {
                        $(row).addClass('table-danger');
                    } else if (data.priority === 'medium') {
                        $(row).addClass('table-warning');
                    } else {
                        $(row).addClass('table-light');
                    }
                }
            });

            // Handle form submission to add a new task
            $("#addTaskForm").submit(function (event) {
                event.preventDefault();
                $form = $(this);
                var formData = {
                    name: $("#taskName").val(),
                    priority: $("#taskPriority").val(),
                    category: $("#taskCategory").val(),
                    due_date: $("#dueDate").val()
                };

                $.ajax({
                    url: '/add',
                    type: 'POST',
                    data: formData,
                    beforeSend: function () {
                        $("#taskFeedback").html('');
                        $form.find('button').prop('disabled', true);
                    },
                    success: function (response) {
                        $("#taskName").val('');
                        $("#taskPriority").val('low');
                        $("#taskCategory").val('personal');
                        $("#dueDate").val('');
                        toastr.success(response.message);
                        // Reload DataTable to reflect the new task
                        $('#taskTable').DataTable().draw(false)
                        rerender();
                    },
                    error: function (xhr, status, error) {
                        var errorMsg = xhr.responseJSON ? xhr.responseJSON.error : "An error occurred.";
                        toastr.error(errorMsg);
                    },
                    complete: function () {
                        $form.find('button').prop('disabled', false);
                    }
                });
            });

            // Handle task completion
            $(document).on('click', '.complete-task', function (event) {
                var taskId = $(this).data('task-id');
                $.ajax({
                    url: '/complete/' + taskId,
                    type: 'POST',
                    success: function (response) {
                        toastr.success('Task completed successfully');
                        rerender();
                        $('#taskTable').DataTable().draw(false)
                    },
                    error: function (xhr, status, error) {
                        toastr.error('Error completing task');
                    }
                });
            });

            $(document).on('click', '.delete-task', function (event) {
                var taskId = $(this).data('task-id');
                $.ajax({
                    url: '/delete/' + taskId,
                    type: 'POST',
                    success: function (response) {
                        toastr.success('Task deleted successfully');
                        rerender();
                        $('#taskTable').DataTable().draw(false)
                    },
                    error: function (xhr, status, error) {
                        toastr.error('Error deleting task');
                    }
                });
            });
        });
    </script>
</body>

</html>